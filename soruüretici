import streamlit as st
from PyPDF2 import PdfReader
import openai
import os
import base64
from io import BytesIO
from fpdf import FPDF

st.set_page_config(page_title="AkÄ±llÄ± Soru Ãœretici", layout="centered")
st.title("ğŸ“˜ AkÄ±llÄ± Soru Ãœretici")
st.markdown("Yapay zekÃ¢ destekli sÄ±nav hazÄ±rlÄ±k aracÄ±")

# OpenAI API anahtarÄ± giriÅŸi
openai_api_key = st.text_input("ğŸ”‘ OpenAI API AnahtarÄ±nÄ±zÄ± girin:", type="password")

# AdÄ±m 1: KullanÄ±cÄ±dan giriÅŸ yÃ¶ntemi seÃ§mesini iste
input_method = st.radio("Veri giriÅŸ yÃ¶ntemini seÃ§in:", ("ğŸ“ Dosya YÃ¼kle", "ğŸ“ Soru TÃ¼rÃ¼nÃ¼ Yaz"))
user_input_text = ""

# Dosya yÃ¼kleme seÃ§ildiyse
if input_method == "ğŸ“ Dosya YÃ¼kle":
    uploaded_file = st.file_uploader("DosyanÄ±zÄ± yÃ¼kleyin (PDF veya TXT)", type=["pdf", "txt"])
    if uploaded_file is not None:
        if uploaded_file.type == "application/pdf":
            pdf = PdfReader(uploaded_file)
            text = ""
            for page in pdf.pages:
                text += page.extract_text()
            user_input_text = text
        elif uploaded_file.type == "text/plain":
            user_input_text = uploaded_file.read().decode("utf-8")

# YazÄ±lÄ± giriÅŸ seÃ§ildiyse
elif input_method == "ğŸ“ Soru TÃ¼rÃ¼nÃ¼ Yaz":
    user_input_text = st.text_area("Soru tÃ¼rlerini ve konularÄ±nÄ± buraya yazÄ±n:", height=300)

# Filtre ve sÄ±nav tipi seÃ§imleri
question_type = st.selectbox("Soru tipi seÃ§in:", ["Klasik", "Ã‡oktan SeÃ§meli", "KarÄ±ÅŸÄ±k"])
filter_keyword = st.text_input("Filtre kelimesi (Ã¶rn. tÃ¼rev, elektrik):")
simulate = st.checkbox("ğŸ¯ SÄ±nav SimÃ¼lasyonu Modu")

# PDF Ã§Ä±ktÄ±sÄ± oluÅŸturma fonksiyonu
def create_pdf(text):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_auto_page_break(auto=True, margin=15)
    pdf.set_font("Arial", size=12)
    for line in text.split('\n'):
        pdf.multi_cell(0, 10, line)
    buffer = BytesIO()
    pdf.output(buffer)
    return buffer

if user_input_text and openai_api_key:
    if st.button("ğŸ” SorularÄ± Ãœret"):
        st.success("Veri alÄ±ndÄ±. Yapay zekÃ¢ya gÃ¶nderiliyor...")

        prompt = f"""
Sen bir sÄ±nav hazÄ±rlÄ±k asistanÄ±sÄ±n. AÅŸaÄŸÄ±da geÃ§miÅŸ sÄ±navlardan alÄ±nmÄ±ÅŸ sorular ya da konu baÅŸlÄ±klarÄ± verilecektir. Bu iÃ§erikler doÄŸrultusunda:
1. Her konu iÃ§in sadece {question_type.lower()} tipi 1-2 Ã¶rnek soru Ã¼ret.
2. Her sorunun ayrÄ±ntÄ±lÄ± Ã§Ã¶zÃ¼mÃ¼nÃ¼ ver.
3. Ä°lgili konu hakkÄ±nda kÄ±sa bir Ã¶zet ve pÃ¼f noktalarÄ± da ekle.
4. Sadece filtrede belirtilen konu veya anahtar kelimeyle ilgili iÃ§erik Ã¼ret (eÄŸer boÅŸsa tÃ¼m konular dahildir).
5. {'SÄ±nav simÃ¼lasyonu gibi sade, doÄŸrudan sadece sorularÄ± Ã¼ret.' if simulate else ''}

Girdi:
{user_input_text}

Filtre:
{filter_keyword}

Cevap:
"""

        try:
            openai.api_key = openai_api_key
            response = openai.ChatCompletion.create(
                model="gpt-4",
                messages=[
                    {"role": "user", "content": prompt}
                ],
                temperature=0.7
            )

            result = response['choices'][0]['message']['content']
            st.markdown("---")
            st.subheader("ğŸ“„ Ãœretilen Ä°Ã§erik:")
            sections = result.split("\n\n")
            for section in sections:
                if any(heading in section.lower() for heading in ["soru", "Ã§Ã¶zÃ¼m", "pÃ¼f", "Ã¶zet"]):
                    st.markdown(f"ğŸ§© {section}")

            # PDF indirme baÄŸlantÄ±sÄ±
            pdf_buffer = create_pdf(result)
            b64_pdf = base64.b64encode(pdf_buffer.getvalue()).decode()
            href = f'<a href="data:application/octet-stream;base64,{b64_pdf}" download="uretilen_sorular.pdf">ğŸ“¥ PDF Olarak Ä°ndir</a>'
            st.markdown(href, unsafe_allow_html=True)

        except Exception as e:
            st.error(f"Bir hata oluÅŸtu: {e}")
elif user_input_text and not openai_api_key:
    st.warning("LÃ¼tfen OpenAI API anahtarÄ±nÄ±zÄ± girin.")

